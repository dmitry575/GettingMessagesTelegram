2022-10-17 10:32:09,652 INFO  (null) Lifetime - Application started. Press Ctrl+C to shut down. 
2022-10-17 10:32:09,718 INFO  (null) Lifetime - Hosting environment: Production 
2022-10-17 10:32:09,721 INFO  (null) Lifetime - Content root path: K:\source\repos\GettingMessagesTelegram\src\bin\Debug\net6.0 
2022-10-17 10:32:10,222 INFO  (null) ReceiveService - Loggin by: Dmitry 
2022-10-17 10:32:14,035 WARN  (null) Validation - Sensitive data logging is enabled. Log entries and exception messages may include sensitive application data; this mode should only be enabled during development. 
2022-10-17 10:32:14,471 INFO  (null) Infrastructure - Entity Framework Core 6.0.9 initialized 'MessagesContext' using provider 'Npgsql.EntityFrameworkCore.PostgreSQL:6.0.7+5b98e4b74de93b590b44aef8dd7967c03acc433c' with options: SensitiveDataLoggingEnabled DetailedErrorsEnabled  
2022-10-17 10:32:19,250 ERROR (null) Connection - An error occurred using the connection to database 'telegram' on server ''. 
2022-10-17 10:32:19,371 ERROR (null) Query - An exception occurred while iterating over the results of a query for context type 'GettingMessagesTelegram.DataAccess.MessagesContext'.
System.InvalidOperationException: An exception has been raised that is likely due to a transient failure.
 ---> Npgsql.NpgsqlException (0x80004005): Failed to connect to 127.0.0.1:5432
 ---> System.Net.Sockets.SocketException (10061): Подключение не установлено, т.к. конечный компьютер отверг запрос на подключение.
   at System.Net.Sockets.Socket.AwaitableSocketAsyncEventArgs.ThrowException(SocketError error, CancellationToken cancellationToken)
   at System.Net.Sockets.Socket.AwaitableSocketAsyncEventArgs.System.Threading.Tasks.Sources.IValueTaskSource.GetResult(Int16 token)
   at System.Net.Sockets.Socket.<ConnectAsync>g__WaitForConnectWithCancellation|277_0(AwaitableSocketAsyncEventArgs saea, ValueTask connectTask, CancellationToken cancellationToken)
   at Npgsql.TaskExtensions.ExecuteWithTimeout(Func`2 func, NpgsqlTimeout timeout, CancellationToken cancellationToken)
   at Npgsql.Internal.NpgsqlConnector.ConnectAsync(NpgsqlTimeout timeout, CancellationToken cancellationToken)
   at Npgsql.Internal.NpgsqlConnector.ConnectAsync(NpgsqlTimeout timeout, CancellationToken cancellationToken)
   at Npgsql.Internal.NpgsqlConnector.RawOpen(SslMode sslMode, NpgsqlTimeout timeout, Boolean async, CancellationToken cancellationToken, Boolean isFirstAttempt)
   at Npgsql.Internal.NpgsqlConnector.<Open>g__OpenCore|195_1(NpgsqlConnector conn, SslMode sslMode, NpgsqlTimeout timeout, Boolean async, CancellationToken cancellationToken, Boolean isFirstAttempt)
   at Npgsql.Internal.NpgsqlConnector.Open(NpgsqlTimeout timeout, Boolean async, CancellationToken cancellationToken)
   at Npgsql.UnpooledConnectorSource.Get(NpgsqlConnection conn, NpgsqlTimeout timeout, Boolean async, CancellationToken cancellationToken)
   at Npgsql.NpgsqlConnection.<Open>g__OpenAsync|45_0(Boolean async, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Storage.RelationalConnection.OpenInternalAsync(Boolean errorsExpected, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Storage.RelationalConnection.OpenInternalAsync(Boolean errorsExpected, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Storage.RelationalConnection.OpenAsync(CancellationToken cancellationToken, Boolean errorsExpected)
   at Microsoft.EntityFrameworkCore.Storage.RelationalCommand.ExecuteReaderAsync(RelationalCommandParameterObject parameterObject, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Query.Internal.SingleQueryingEnumerable`1.AsyncEnumerator.InitializeReaderAsync(AsyncEnumerator enumerator, CancellationToken cancellationToken)
   at Npgsql.EntityFrameworkCore.PostgreSQL.Storage.Internal.NpgsqlExecutionStrategy.ExecuteAsync[TState,TResult](TState state, Func`4 operation, Func`4 verifySucceeded, CancellationToken cancellationToken)
   --- End of inner exception stack trace ---
   at Npgsql.EntityFrameworkCore.PostgreSQL.Storage.Internal.NpgsqlExecutionStrategy.ExecuteAsync[TState,TResult](TState state, Func`4 operation, Func`4 verifySucceeded, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Query.Internal.SingleQueryingEnumerable`1.AsyncEnumerator.MoveNextAsync() 
System.InvalidOperationException: An exception has been raised that is likely due to a transient failure.
 ---> Npgsql.NpgsqlException (0x80004005): Failed to connect to 127.0.0.1:5432
 ---> System.Net.Sockets.SocketException (10061): Подключение не установлено, т.к. конечный компьютер отверг запрос на подключение.
   at System.Net.Sockets.Socket.AwaitableSocketAsyncEventArgs.ThrowException(SocketError error, CancellationToken cancellationToken)
   at System.Net.Sockets.Socket.AwaitableSocketAsyncEventArgs.System.Threading.Tasks.Sources.IValueTaskSource.GetResult(Int16 token)
   at System.Net.Sockets.Socket.<ConnectAsync>g__WaitForConnectWithCancellation|277_0(AwaitableSocketAsyncEventArgs saea, ValueTask connectTask, CancellationToken cancellationToken)
   at Npgsql.TaskExtensions.ExecuteWithTimeout(Func`2 func, NpgsqlTimeout timeout, CancellationToken cancellationToken)
   at Npgsql.Internal.NpgsqlConnector.ConnectAsync(NpgsqlTimeout timeout, CancellationToken cancellationToken)
   at Npgsql.Internal.NpgsqlConnector.ConnectAsync(NpgsqlTimeout timeout, CancellationToken cancellationToken)
   at Npgsql.Internal.NpgsqlConnector.RawOpen(SslMode sslMode, NpgsqlTimeout timeout, Boolean async, CancellationToken cancellationToken, Boolean isFirstAttempt)
   at Npgsql.Internal.NpgsqlConnector.<Open>g__OpenCore|195_1(NpgsqlConnector conn, SslMode sslMode, NpgsqlTimeout timeout, Boolean async, CancellationToken cancellationToken, Boolean isFirstAttempt)
   at Npgsql.Internal.NpgsqlConnector.Open(NpgsqlTimeout timeout, Boolean async, CancellationToken cancellationToken)
   at Npgsql.UnpooledConnectorSource.Get(NpgsqlConnection conn, NpgsqlTimeout timeout, Boolean async, CancellationToken cancellationToken)
   at Npgsql.NpgsqlConnection.<Open>g__OpenAsync|45_0(Boolean async, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Storage.RelationalConnection.OpenInternalAsync(Boolean errorsExpected, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Storage.RelationalConnection.OpenInternalAsync(Boolean errorsExpected, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Storage.RelationalConnection.OpenAsync(CancellationToken cancellationToken, Boolean errorsExpected)
   at Microsoft.EntityFrameworkCore.Storage.RelationalCommand.ExecuteReaderAsync(RelationalCommandParameterObject parameterObject, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Query.Internal.SingleQueryingEnumerable`1.AsyncEnumerator.InitializeReaderAsync(AsyncEnumerator enumerator, CancellationToken cancellationToken)
   at Npgsql.EntityFrameworkCore.PostgreSQL.Storage.Internal.NpgsqlExecutionStrategy.ExecuteAsync[TState,TResult](TState state, Func`4 operation, Func`4 verifySucceeded, CancellationToken cancellationToken)
   --- End of inner exception stack trace ---
   at Npgsql.EntityFrameworkCore.PostgreSQL.Storage.Internal.NpgsqlExecutionStrategy.ExecuteAsync[TState,TResult](TState state, Func`4 operation, Func`4 verifySucceeded, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Query.Internal.SingleQueryingEnumerable`1.AsyncEnumerator.MoveNextAsync()
2022-10-17 10:35:29,537 INFO  (null) Lifetime - Application started. Press Ctrl+C to shut down. 
2022-10-17 10:35:29,637 INFO  (null) Lifetime - Hosting environment: Production 
2022-10-17 10:35:29,655 INFO  (null) Lifetime - Content root path: K:\source\repos\GettingMessagesTelegram\src\bin\Debug\net6.0 
2022-10-17 10:35:30,384 INFO  (null) ReceiveService - Loggin by: Dmitry 
2022-10-17 10:35:33,594 WARN  (null) Validation - Sensitive data logging is enabled. Log entries and exception messages may include sensitive application data; this mode should only be enabled during development. 
2022-10-17 10:35:33,948 INFO  (null) Infrastructure - Entity Framework Core 6.0.9 initialized 'MessagesContext' using provider 'Npgsql.EntityFrameworkCore.PostgreSQL:6.0.7+5b98e4b74de93b590b44aef8dd7967c03acc433c' with options: SensitiveDataLoggingEnabled DetailedErrorsEnabled  
2022-10-17 10:35:35,609 INFO  (null) Command - Executed DbCommand (96ms) [Parameters=[@__baseId_0='1101806611'], CommandType='Text', CommandTimeout='300']
SELECT c."Id", c."Author", c."BaseId", c."DateCreated", c."HashAccess", c."MessagesCount"
FROM "Channels" AS c
WHERE c."BaseId" = @__baseId_0
LIMIT 1 
2022-10-17 10:36:01,842 INFO  (null) ReceiveService - reading messages was finished from channel: 1101806611 
2022-10-17 10:36:36,019 INFO  (null) Command - Executed DbCommand (2ms) [Parameters=[@__baseId_0='1490307805'], CommandType='Text', CommandTimeout='300']
SELECT c."Id", c."Author", c."BaseId", c."DateCreated", c."HashAccess", c."MessagesCount"
FROM "Channels" AS c
WHERE c."BaseId" = @__baseId_0
LIMIT 1 
2022-10-17 10:36:40,868 INFO  (null) Command - Executed DbCommand (10ms) [Parameters=[@p0='zhivoff', @p1='1490307805', @p2='2022-10-17T07:36:38.6096999Z' (DbType = DateTime), @p3='4006953120203002319', @p4='0'], CommandType='Text', CommandTimeout='300']
INSERT INTO "Channels" ("Author", "BaseId", "DateCreated", "HashAccess", "MessagesCount")
VALUES (@p0, @p1, @p2, @p3, @p4)
RETURNING "Id"; 
2022-10-17 10:36:56,675 INFO  (null) ReceiveService - reading messages was finished from channel: 1490307805 
2022-10-17 10:37:05,710 INFO  (null) Command - Executed DbCommand (2ms) [Parameters=[@__baseId_0='1326223284'], CommandType='Text', CommandTimeout='300']
SELECT c."Id", c."Author", c."BaseId", c."DateCreated", c."HashAccess", c."MessagesCount"
FROM "Channels" AS c
WHERE c."BaseId" = @__baseId_0
LIMIT 1 
2022-10-17 10:37:07,405 INFO  (null) Command - Executed DbCommand (2ms) [Parameters=[@p0='rybar', @p1='1326223284', @p2='2022-10-17T07:37:06.7381695Z' (DbType = DateTime), @p3='527308492744278632', @p4='0'], CommandType='Text', CommandTimeout='300']
INSERT INTO "Channels" ("Author", "BaseId", "DateCreated", "HashAccess", "MessagesCount")
VALUES (@p0, @p1, @p2, @p3, @p4)
RETURNING "Id"; 
2022-10-17 10:37:09,341 INFO  (null) ReceiveService - reading messages from channel: 1326223284 
2022-10-17 10:46:29,213 INFO  (null) ReceiveService - new message: 40316 - start 
2022-10-17 10:46:31,945 INFO  (null) Command - Executed DbCommand (5ms) [Parameters=[@__channelId_0='4', @__baseId_1='40316'], CommandType='Text', CommandTimeout='300']
SELECT t."Id", t."Author", t."BaseId", t."ChannelId", t."CommentCount", t."Content", t."DateCreated", t."ViewCount", c."Id", c."Author", c."BaseId", c."Content", c."DateCreated", c."MessageId"
FROM (
    SELECT m."Id", m."Author", m."BaseId", m."ChannelId", m."CommentCount", m."Content", m."DateCreated", m."ViewCount"
    FROM "Messages" AS m
    WHERE (m."ChannelId" = @__channelId_0) AND (m."BaseId" = @__baseId_1)
    LIMIT 1
) AS t
LEFT JOIN "Comments" AS c ON t."Id" = c."MessageId"
ORDER BY t."Id" 
2022-10-17 10:46:33,961 INFO  (null) MessageProcess - 40316	 
2022-10-17 10:47:04,880 ERROR (null) MessageProcess - get comments for message: 40316 failed, page: 0, code: 400, TL.RpcException: 400 MSG_ID_INVALID
   at WTelegram.Client.Invoke[T](IMethod`1 query)
   at GettingMessagesTelegram.Process.Impl.MessageProcess.ProcessComments(Message message, InputPeerChannel peerChanel, Int32 telegramMessageId) in K:\source\repos\GettingMessagesTelegram\src\Process\Impl\MessageProcess.cs:line 200 
2022-10-17 10:47:05,683 INFO  (null) MessageProcess - TL.MessageMediaPhoto 
2022-10-17 10:47:55,118 INFO  (null) MessageProcess - starting download photo file 5938329016354322235 to /var/tmp\5938329016354322235 
2022-10-17 10:48:00,687 INFO  (null) MessageProcess - downloaded photo file 5938329016354322235 to /var/tmp\5938329016354322235 
